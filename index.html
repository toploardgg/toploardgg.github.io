<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ReRoR</title>
  <style>
    body { font-family: monospace; background: #fafafa; color: #222; margin: 0; }
    .container { max-width: 700px; margin: 40px auto; padding: 20px; background: #fff; border-radius: 8px; }
    h1 { text-align: center; }
    .thread, .post { border: 1px solid #ddd; margin: 10px 0; padding: 10px; border-radius: 5px; }
    .author { color: #888; font-size: 12px; }
    .comment-list { margin-left: 20px; }
    .form-group { margin-bottom: 10px; }
    input, textarea { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 3px; }
    button { padding: 8px 16px; }
    .error { color: red; }
    #logout { float: right; }
    .link { color: #06c; cursor: pointer; text-decoration: underline; }
    #bottom-btns { margin-top: 18px; text-align: center; }
  </style>
</head>
<body>
  <div class="container" id="app"></div>
  <script>
    // --- User password/email storage ---
    function getUsers() {
      return JSON.parse(localStorage.getItem('users') || '{}');
    }
    function saveUsers(users) {
      localStorage.setItem('users', JSON.stringify(users));
    }

    // ---- Simple "Auth" ----
    let user = null;
    function saveUser(u) { user = u; sessionStorage.setItem('user', JSON.stringify(u)); }
    function loadUser() {
      let u = sessionStorage.getItem('user');
      user = u ? JSON.parse(u) : null;
    }
    function logout() { user = null; sessionStorage.removeItem('user'); render(); }

    // ---- Dummy DB (in memory) ----
    let threads = JSON.parse(localStorage.getItem('threads') || '[]');
    function saveThreads() { localStorage.setItem('threads', JSON.stringify(threads)); }

    // ---- Rendering ----
    function render(mode = "login", formData = {}) {
      loadUser();
      let app = document.getElementById('app');
      if (!user) {
        if (mode === "register") {
          app.innerHTML = `
            <h1>Register</h1>
            <form id="register-form">
              <div class="form-group">
                <label>Nickname:</label>
                <input name="nick" required maxlength="20" value="${formData.nick||""}">
              </div>
              <div class="form-group">
                <label>Email:</label>
                <input name="email" type="email" required maxlength="50" value="${formData.email||""}">
              </div>
              <div class="form-group">
                <label>Password (min. 12 characters):</label>
                <input name="pass" type="password" required minlength="12">
              </div>
              <div id="register-err" class="error"></div>
              <button>Register</button>
              <span class="link" id="back-to-login" style="margin-left:18px;">Back to login</span>
            </form>
          `;
          document.getElementById('back-to-login').onclick = (e)=>{ e.preventDefault(); render("login"); };
          app.querySelector('#register-form').onsubmit = (e) => {
            e.preventDefault();
            let nick = e.target.nick.value.trim();
            let email = e.target.email.value.trim().toLowerCase();
            let pass = e.target.pass.value;
            let users = getUsers();
            if (users[nick]) {
              document.getElementById('register-err').textContent = "Nickname is already taken!";
              return;
            }
            if (pass.length < 12) {
              document.getElementById('register-err').textContent = "Password too short!";
              return;
            }
            users[nick] = { email: email, pass: pass };
            saveUsers(users);
            saveUser({nick: nick, email: email});
            render();
          };
          return;
        }

        // LOGIN FORM
        app.innerHTML = `
          <h1>Forum Login</h1>
          <form id="login">
            <div class="form-group">
              <label>Nickname:</label>
              <input name="nick" required maxlength="20" value="${formData.nick||""}">
            </div>
            <div class="form-group">
              <label>Password:</label>
              <input name="pass" type="password" required minlength="12">
            </div>
            <div id="login-err" class="error"></div>
            <button>Login</button>
          </form>
          <div id="bottom-btns">
            <button id="register-btn" type="button">Register</button>
          </div>
        `;
        document.getElementById('register-btn').onclick = (e)=>{ e.preventDefault(); render("register"); };
        app.querySelector('#login').onsubmit = (e) => {
          e.preventDefault();
          let nick = e.target.nick.value.trim();
          let pass = e.target.pass.value;
          let users = getUsers();
          if (!users[nick]) {
            document.getElementById('login-err').textContent = "Account not registered!";
            return;
          }
          if (users[nick].pass !== pass) {
            document.getElementById('login-err').textContent = "Incorrect password!";
            return;
          }
          saveUser({nick: nick, email: users[nick].email});
          render();
        };
        return;
      }

      // LOGGED IN
      let html = `
        <button id="logout">Logout</button>
        <h1>Forum</h1>
        <h2>Create new thread</h2>
        <form id="new-thread">
          <div class="form-group">
            <input name="title" placeholder="Title" maxlength="100" required>
          </div>
          <div class="form-group">
            <textarea name="text" placeholder="Your post..." required></textarea>
          </div>
          <button>Post</button>
        </form>
        <h2>Threads</h2>
        ${threads.map((th,i)=>`
          <div class="thread">
            <b>${th.title}</b><br>
            <span class="author">By: ${th.nick}</span>
            <div>${th.text}</div>
            <div class="comment-list">
              ${th.comments.map(c=>`
                <div class="post">
                  <span class="author">${c.nick}</span>: ${c.text}
                </div>
              `).join('')}
              <form class="comment-form" data-i="${i}">
                <input name="comment" placeholder="Comment" required>
                <button>Reply</button>
              </form>
            </div>
          </div>
        `).join('')}
      `;
      app.innerHTML = html;

      // Logout
      document.getElementById('logout').onclick = logout;

      // New thread
      app.querySelector('#new-thread').onsubmit = (e)=>{
        e.preventDefault();
        let title = e.target.title.value.trim();
        let text = e.target.text.value.trim();
        if (!title || !text) return;
        threads.unshift({title, text, nick: user.nick, comments: []});
        saveThreads();
        render();
      };

      // Comments
      app.querySelectorAll('.comment-form').forEach(form=>{
        form.onsubmit = (e)=>{
          e.preventDefault();
          let i = +form.dataset.i;
          let comment = form.comment.value.trim();
          if (!comment) return;
          threads[i].comments.push({nick: user.nick, text: comment});
          saveThreads();
          render();
        }
      });
    }
    render();
  </script>
</body>
</html>