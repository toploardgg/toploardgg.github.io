const translations = {
    en: {
        greeting: "Hi.",
        cookies: "I love cookies)<🍪",
        name: "Toploardgg (Stas)",
        tyretName: "tyret (Artem)",
        kapibaraName: "KAPIBARA (Kolya)",
        aterName: "ater (Dinis)",
        contact: "Contacts:",
        support: "Support us:",
        donate: "Donate with PayPal",
        language: "English",
        tabProfile: "Profile",
        tabInfo: "Info",
        tabFiles: "Files",
        infoTitle: "Information",
        ipLabel: "IP Address:",
        linkLabel: "Link:",
        discordLinkText: "discord group",
        applicationMessage: "To join the server, you need to apply in Discord; all details are in Toploardgg.",
        rulesHeading: "Server Rules:",
        rule_1: "Don't tell anyone about Fight Club.",
        rule_2: "Do not destroy other players' bases or build without permission. Violation - one week ban.",
        rule_3: "Spam in Minecraft or on the Discord server, or posting irrelevant information in the Telegram group - 1 day mute (sending photos is allowed, as is any kind of information like coordinates or resource locations).",
        rule_4: "CHEATS ARE STRICTLY PROHIBITED in any form: resource packs or mods for ore visibility, or powerful cheats. Violation - ban from 1 day to permanent depending on the severity of the cheats. To clarify if a mod is a cheat, you need to ask the administrator (me). You can ask for unban, but you must write the reason in at least 3 sentences.",
        rule_5: "Do not provoke or be provoked. Violation - 1 day.",
        rule_6: "Do not judge a person based on their differences: weight, age, etc. Violation - 1 week.",
        rule_7: "Swearing in voice chat is not recommended.",
        rule_8: "You cannot build lag machines or other mechanisms that interfere with the server and reduce TPS.",
        rule_9: "You can only speak Ukrainian or at least Surzhyk.",
        serverStatusHeading: "Server Status:",
        statusLabel: "Status:",
        statusOnline: "Online",
        statusOffline: "Offline",
        statusLoading: "Loading...",
        playersLabel: "Players:",
        versionLabel: "Version:",
        motdLabel: "MOTD:",
        refreshButton: "Refresh",
        errorFetchingStatus: "Error fetching status.",
        statusOfflineMOTD: "Offline",
        filesTitle: "Files",
        filesDescription: "Here you can download server-related files, including the official resource packs and the build.",
        resourcepackDownloadOptifine: "Resource Pack (OptiFine)",
        resourcepackDownloadNonOptifine: "Resource Pack (Non-OptiFine)",
        filesDownloadBuild: "My Build",
        filesDownloadWorld: "world 1 season (Not available yet)",
        switchToDarkTheme: "Dark Theme",
        switchToLightTheme: "Light Theme"
    },
    ru: {
        greeting: "Привет.",
        cookies: "Я люблю печеньки)<🍪",
        name: "Toploardgg (Стас)",
        tyretName: "tyret (Артём)",
        kapibaraName: "KAPIBARA (Коля)",
        aterName: "ater (Денис)",
        contact: "Контакты:",
        support: "Поддержите нас:",
        donate: "Пожертвовать через PayPal",
        language: "Русский",
        tabProfile: "Профиль",
        tabInfo: "Инфо",
        tabFiles: "Файлы",
        infoTitle: "Информация",
        ipLabel: "IP Адрес:",
        linkLabel: "Ссылка:",
        discordLinkText: "группа в Discord",
        applicationMessage: "Чтобы попасть на сервер, надо подать заявку в Discord; все детали в Toploardgg.",
        rulesHeading: "Правила сервера:",
        rule_1: "Никому не рассказывать о Бойцовском Клубе.",
        rule_2: "Нельзя разрушать базы других игроков, а также строить без разрешения. Нарушение - неделя бана.",
        rule_3: "Спам в Minecraft или на Discord сервере, или написание неважной информации в Telegram группу - мут на 1 день (фотографии отправлять можно, информация любого вида - как координаты, так и нахождение ресурсов - тоже).",
        rule_4: "ЧИТЫ СТРОГО ЗАПРЕЩЕНЫ в любом виде: ресурспаки или моды на видимость руд, или сильные читы. Нарушение - бан от 1 дня до навсегда в зависимости от силы читов. Чтобы уточнить, является ли мод читом, нужно спросить у администратора (у меня). Разбан можно попросить, но нужно написать причину минимум 3 предложения.",
        rule_5: "Не провоцировать и не поддаваться на провокации. Нарушение - 1 день.",
        rule_6: "Нельзя осуждать человека за его отличия: вес, возраст и т.д. Нарушение - 1 неделя.",
        rule_7: "Нецензурная брань в голосовом чате нежелательна.",
        rule_8: "Нельзя строить лаг-машины или другие механизмы, которые мешают серверу и уменьшают TPS.",
        rule_9: "Разговаривать можно только на Украинском или по крайней мере на суржике.",
        serverStatusHeading: "Статус сервера:",
        statusLabel: "Статус:",
        statusOnline: "Онлайн",
        statusOffline: "Офлайн",
        statusLoading: "Загрузка...",
        playersLabel: "Игроков:",
        versionLabel: "Версия:",
        motdLabel: "MOTD:",
        refreshButton: "Обновить",
        errorFetchingStatus: "Ошибка получения статуса.",
        statusOfflineMOTD: "Офлайн",
        filesTitle: "Файлы",
        filesDescription: "Здесь вы можете скачать файлы, относящиеся к серверу, включая официальные ресурспаки и сборку.",
        resourcepackDownloadOptifine: "Ресурспак (OptiFine)",
        resourcepackDownloadNonOptifine: "Ресурспак (Non-OptiFine)",
        filesDownloadBuild: "Моя Сборка",
        filesDownloadWorld: "Мир 1 сезону (Пока что нельзя)",
        switchToDarkTheme: "Темная тема",
        switchToLightTheme: "Светлая тема"
    },
    uk: {
        greeting: "Привіт.",
        cookies: "Я обожнюю пряники)<🍪",
        name: "Toploardgg (Стаc)",
        tyretName: "tyret (Артем)",
        kapibaraName: "KAPIBARA (Коля)",
        aterName: "ater (Денис)",
        contact: "Контакти:",
        support: "Підтримайте нас:",
        donate: "Пожертвувати через PayPal",
        language: "Українська",
        tabProfile: "Профіль",
        tabInfo: "Інформація",
        tabFiles: "Файли",
        infoTitle: "Інформація",
        ipLabel: "IP Адреса:",
        linkLabel: "Посилання:",
        discordLinkText: "група в Discord",
        applicationMessage: "Щоб потрапити на сервер, треба подати заявку в діскорд всі деталі в Toploardgg.",
        rulesHeading: "Правила сервера:",
        rule_1: "Нікому не розказувати за Бійцівський Клуб.",
        rule_2: "Не можна руйнувати базу інших ігроків а також строїти без дозволу порушення-тиждень бану.",
        rule_3: "Спам у Minecraft або на Discord сервері, або надсилання неважливої інформації до Telegram групи - мут на 1 день (фотографії надсилати можна, інформацію будь-якого виду - як координати, так і знаходження ресурсів - також).",
        rule_4: "ЧІТИ СУВОРО ЗАБОРОНЕНІ у будь-якому вигляді: ресурспаки або моди на видимість руд, або сильні чити. Нарушення - бан від 1 дня до назавжди залежно від сили читів. Щоб уточнити, чи є мод читом, потрібно запитати у адміністратора (у мене). Розбан можна попросити, але потрібно написати причину мін. 3 речення.",
        rule_5: "Не провокувати і не піддаватися на провокації. Порушення - 1 день.",
        rule_6: "Не можна засуджувати людину за її відмінності: вага, вік тощо. Порушення - 1 тиждень.",
        rule_7: "Матюкатися у голосовому чаті краще не треба.",
        rule_8: "не можна строїти лаг машини або інші механізми які мішають серверу та зменшують тпс.",
        rule_9: "розмовляти можна тільки Українською або принаймі суржиком.",
        serverStatusHeading: "Статус сервера:",
        statusLabel: "Статус:",
        statusOnline: "Онлайн",
        statusOffline: "Офлайн",
        statusLoading: "Загрузка...",
        playersLabel: "Игроков:",
        versionLabel: "Версия:",
        motdLabel: "MOTD:",
        refreshButton: "Оновити",
        errorFetchingStatus: "Помилка отримання статусу.",
        statusOfflineMOTD: "Офлайн",
        filesTitle: "Файли",
        filesDescription: "Тут ви можете завантажити файли, що стосуються сервера, включаючи офіційні ресурспаки та збірку.",
        resourcepackDownloadOptifine: "Ресурспак (OptiFine)",
        resourcepackDownloadNonOptifine: "Ресурспак (Non-OptiFine)",
        filesDownloadBuild: "Моя Збірка",
        filesDownloadWorld: "Світ 1 сезону (Поки що не можна)",
        switchToDarkTheme: "Темна тема",
        switchToLightTheme: "Світла тема"
    }
};

const statusIndicator = document.getElementById('status-indicator');
const serverOnlineInfo = document.getElementById('server-online-info');
const playersOnline = document.getElementById('players-online');
const playersMax = document.getElementById('players-max');
const serverVersion = document.getElementById('server-version');
const serverMotd = document.getElementById('server-motd');
const serverRefreshButton = document.getElementById('server-refresh-button');
const bodyElement = document.body;
const themeToggle = document.getElementById('theme-toggle');
const languageButton = document.getElementById('language-button');

const ATERNOS_SERVER_ADDRESS_PORT = 'Toploardgg.aternos.me:39466';
const EXPECTED_MOTD = 'Welcome to the server of Toploardgg!';
const MCSTATUS_API_URL = `https://api.mcstatus.io/v2/status/java/${ATERNOS_SERVER_ADDRESS_PORT}`;

function setTheme(theme) {
    const currentLang = localStorage.getItem('preferredLanguage') || 'en';
    const currentTranslations = translations[currentLang];

    if (theme === 'light') {
        bodyElement.classList.add('light-theme');
        if (themeToggle) themeToggle.textContent = currentTranslations.switchToDarkTheme;
    } else {
        bodyElement.classList.remove('light-theme');
        if (themeToggle) themeToggle.textContent = currentTranslations.switchToLightTheme;
    }
    try {
        localStorage.setItem('theme', theme);
    } catch (e) {
        console.error('Failed to save theme preference to localStorage:', e);
    }
}

if (themeToggle) {
    themeToggle.addEventListener('click', () => {
        const currentTheme = bodyElement.classList.contains('light-theme') ? 'light' : 'dark';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        setTheme(newTheme);
    });
}

function loadThemePreference() {
    let savedTheme = null;
    try {
        savedTheme = localStorage.getItem('theme');
    } catch (e) {
        console.error('Failed to load theme preference from localStorage:', e);
    }

    if (savedTheme) {
        setTheme(savedTheme);
    } else {
        setTheme('dark');
    }
}


function showTab(tabIdToShow) {
    const contents = document.querySelectorAll('.tab-content');
    contents.forEach(content => {
        content.classList.remove('active');
    });
    const buttons = document.querySelectorAll('.tab-button');
    buttons.forEach(button => {
        button.classList.remove('active');
    });

    const contentToShow = document.getElementById(`tab-content-${tabIdToShow}`);
    if (contentToShow) {
        contentToShow.classList.add('active');
        if (tabIdToShow === 'info') {
            fetchServerStatus();
            startStatusInterval();
        } else {
            stopStatusInterval();
        }
    }

    const buttonToActivate = document.getElementById(`tab-btn-${tabIdToShow}`);
    if (buttonToActivate) {
        buttonToActivate.classList.add('active');
    }
}

function changeLanguage(lang) {
    const currentTranslations = translations[lang];
    if (!currentTranslations) {
        console.warn(`Translations for language '${lang}' not found.`);
        return;
    }

    try {
        localStorage.setItem('preferredLanguage', lang);
    } catch (e) {
        console.error('Failed to save language preference to localStorage:', e);
    }

    document.getElementById("greeting").textContent = currentTranslations.greeting;
    document.getElementById("I-love-cookies").textContent = currentTranslations.cookies;
    document.getElementById("name").textContent = currentTranslations.name;
    document.getElementById("tyret-name").textContent = currentTranslations.tyretName;
    document.getElementById("kapibara-name").textContent = currentTranslations.kapibaraName;
    document.getElementById("ater-name").textContent = currentTranslations.aterName;
    document.getElementById("contact").textContent = currentTranslations.contact;
    document.getElementById("support").textContent = currentTranslations.support;
    document.getElementById("donate").textContent = currentTranslations.donate;
    document.getElementById("I-love-cookies-footer").textContent = currentTranslations.cookies;

    if (languageButton) {
        languageButton.textContent = currentTranslations.language;
    }

    document.getElementById("tab-btn-profile").textContent = currentTranslations.tabProfile;
    document.getElementById("tab-btn-info").textContent = currentTranslations.tabInfo;

    const tabFilesButton = document.getElementById("tab-btn-files");
    if (tabFilesButton) {
        tabFilesButton.textContent = currentTranslations.tabFiles;
    }

    document.getElementById("info-title").textContent = currentTranslations.infoTitle;
    document.getElementById("ip-label").textContent = currentTranslations.ipLabel;
    document.getElementById("linkLabel").textContent = currentTranslations.linkLabel;
    document.getElementById("discord-link-text").textContent = currentTranslations.discordLinkText;

    const applicationMessageElement = document.getElementById("application-message");
    if (applicationMessageElement) {
        applicationMessageElement.textContent = currentTranslations.applicationMessage;
    }

    const rulesHeading = document.getElementById("rules-heading");
    if (rulesHeading) {
        rulesHeading.textContent = currentTranslations.rulesHeading;
    }

    for (let i = 1; i <= 9; i++) {
        const ruleElement = document.getElementById(`rule-${i}`);
        if (ruleElement) {
            ruleElement.textContent = currentTranslations[`rule_${i}`];
        }
    }

    const serverStatusHeading = document.getElementById('server-status-heading');
    const statusLabel = document.getElementById('status-label');
    const playersLabel = document.getElementById('players-label');
    const versionLabel = document.getElementById('version-label');
    const motdLabel = document.getElementById('motd-label');
    const refreshButton = document.getElementById('server-refresh-button');

    if (serverStatusHeading) serverStatusHeading.textContent = currentTranslations.serverStatusHeading;
    if (statusLabel) statusLabel.textContent = currentTranslations.statusLabel;
    if (playersLabel) playersLabel.textContent = currentTranslations.playersLabel;
    if (versionLabel) versionLabel.textContent = currentTranslations.versionLabel;
    if (motdLabel) motdLabel.textContent = currentTranslations.motdLabel;
    if (refreshButton) refreshButton.textContent = currentTranslations.refreshButton;

    if (statusIndicator) {
        if (statusIndicator.classList.contains('status-online')) {
             statusIndicator.textContent = currentTranslations.statusOnline;
        } else if (statusIndicator.classList.contains('status-offline')) {
            const currentText = statusIndicator.textContent;
            let errorPart = '';
            const errorMatch = currentText.match(/\s?\(.+\)$/);
             if (errorMatch) {
                 errorPart = errorMatch[0];
             }

            let baseOfflineText = currentTranslations.statusOffline;
            const oldLangs = ['en', 'ru', 'uk'];
            let wasOfflineMotd = false;
            for (const langKey of oldLangs) {
                 const oldMotdOfflineText = translations[langKey].statusOfflineMOTD;
                 if (currentText.trim().startsWith(oldMotdOfflineText.substring(0, oldMotdOfflineText.indexOf('(')).trim())) {
                      wasOfflineMotd = true;
                      break;
                 }
            }

            if (wasOfflineMotd) {
                baseOfflineText = currentTranslations.statusOfflineMOTD;
            }

            statusIndicator.textContent = baseOfflineText + errorPart;

        } else if (statusIndicator.classList.contains('status-loading')) {
             statusIndicator.textContent = currentTranslations.statusLoading;
        }
    }

    const filesTitleElement = document.getElementById('files-title');
    const filesDescriptionElement = document.getElementById('files-description');
    const resourcepackDownloadOptifineElement = document.getElementById('resourcepack-download-optifine');
    const resourcepackDownloadNonOptifineElement = document.getElementById('resourcepack-download-nonoptifine');
    const filesDownloadBuildElement = document.getElementById('files-download-build');
    const filesDownloadWorldElement = document.getElementById('files-download-world');

    if (filesTitleElement) filesTitleElement.textContent = currentTranslations.filesTitle;
    if (filesDescriptionElement) filesDescriptionElement.textContent = currentTranslations.filesDescription;
    if (resourcepackDownloadOptifineElement) resourcepackDownloadOptifineElement.textContent = currentTranslations.resourcepackDownloadOptifine;
    if (resourcepackDownloadNonOptifineElement) resourcepackDownloadNonOptifineElement.textContent = currentTranslations.resourcepackDownloadNonOptifine;
    if (filesDownloadBuildElement) filesDownloadBuildElement.textContent = currentTranslations.filesDownloadBuild;
    if (filesDownloadWorldElement) filesDownloadWorldElement.textContent = currentTranslations.filesDownloadWorld;

    const currentTheme = bodyElement.classList.contains('light-theme') ? 'light' : 'dark';
    setTheme(currentTheme);
}

async function fetchServerStatus() {
    const currentLang = localStorage.getItem('preferredLanguage') || 'en';
    const currentTranslations = translations[currentLang];

    statusIndicator.textContent = currentTranslations.statusLoading;
    statusIndicator.className = 'server-status-indicator status-loading';
    serverOnlineInfo.style.display = 'none';
    serverRefreshButton.disabled = true;

    try {
        const response = await fetch(MCSTATUS_API_URL);
        if (!response.ok) {
            let errorDetail = `HTTP error! status: ${response.status}`;
            try {
                 const errorData = await response.json();
                 if (errorData && errorData.error) {
                      errorDetail = errorData.error;
                 } else if (errorData) {
                      errorDetail = JSON.stringify(errorData);
                 }
            } catch (e) {
            }
            throw new Error(errorDetail);
        }
        const data = await response.json();

        const receivedMotdRaw = data.motd ? (data.motd.clean || data.motd.raw || '') : '';
        const receivedMotdClean = receivedMotdRaw.replace(/§[0-9a-fk-or]/gi, '').trim();

        const isOnlineByApi = data.online === true;
        const isMotdMatching = receivedMotdClean.toLowerCase().trim() === EXPECTED_MOTD.toLowerCase().trim();

        if (isOnlineByApi && isMotdMatching) {
            statusIndicator.textContent = currentTranslations.statusOnline;
            statusIndicator.className = 'server-status-indicator status-online';
            playersOnline.textContent = data.players ? data.players.online : 0;
            playersMax.textContent = data.players ? data.players.max : 0;
            serverVersion.textContent = data.version ? data.version.name : 'N/A';
            serverMotd.textContent = receivedMotdClean || 'N/A';
            serverOnlineInfo.style.display = 'block';
        } else {
            let offlineMessage = currentTranslations.statusOffline;
            if (isOnlineByApi && !isMotdMatching) {
                offlineMessage = `${currentTranslations.statusOfflineMOTD} ${receivedMotdClean ? `(${receivedMotdClean})` : ''}`;
            } else if (data.error) {
                 offlineMessage = `${currentTranslations.statusOffline} (${data.error})`;
            } else if (!isOnlineByApi) {
                 offlineMessage = currentTranslations.statusOffline;
            } else {
                 offlineMessage = `${currentTranslations.statusOffline} (${currentTranslations.errorFetchingStatus})`;
            }

            statusIndicator.textContent = offlineMessage;
            statusIndicator.className = 'server-status-indicator status-offline';
            serverOnlineInfo.style.display = 'none';
            serverMotd.textContent = '-';
        }
    } catch (error) {
        console.error('Ошибка при получении статуса:', error);
        const currentLang = localStorage.getItem('preferredLanguage') || 'en';
        const currentTranslations = translations[currentLang];
        const errorMessage = error.message && !error.message.includes('HTTP error! status: undefined') ? error.message : currentTranslations.errorFetchingStatus;
        statusIndicator.textContent = `${currentTranslations.statusOffline} (${errorMessage})`;
        statusIndicator.className = 'server-status-indicator status-offline';
        serverOnlineInfo.style.display = 'none';
        serverMotd.textContent = '-';
    } finally {
        serverRefreshButton.disabled = false;
    }
}

const refreshInterval = 60000;
let statusIntervalId = null;

function startStatusInterval() {
    if (statusIntervalId === null) {
        fetchServerStatus();
        statusIntervalId = setInterval(() => {
            const activeTabElement = document.querySelector('.tab-content.active');
            const activeTabId = activeTabElement ? activeTabElement.id.replace('tab-content-', '') : null;
            if (activeTabId === 'info') {
                fetchServerStatus();
            }
        }, refreshInterval);
    }
}

function stopStatusInterval() {
    if (statusIntervalId !== null) {
        clearInterval(statusIntervalId);
        statusIntervalId = null;
    }
}

if (serverRefreshButton) {
    serverRefreshButton.addEventListener('click', fetchServerStatus);
}

document.addEventListener('DOMContentLoaded', () => {
    let savedLang = 'en';
    try {
        const savedLangPref = localStorage.getItem('preferredLanguage');
        if (savedLangPref && translations[savedLangPref]) {
            savedLang = savedLangPref;
        }
    } catch (e) {
        console.error('Failed to load language preference from localStorage:', e);
    }
    changeLanguage(savedLang);

    loadThemePreference();

    const initialTabId = 'profile';
    showTab(initialTabId);
});

window.addEventListener('beforeunload', stopStatusInterval);