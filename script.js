const translations = {
    en: {
        greeting: "Hi.",
        cookies: "I love cookies)<🍪",
        name: "Toploardgg (Stas)",
        tyretName: "tyret (Artem)",
        kapibaraName: "KAPIBARA (Kolya)",
        aterName: "ater (Dinis)",
        artfixName: "Artfix (artem)",
        contact: "Contacts:",
        support: "Support us:",
        donate: "Donate with PayPal",
        language: "English",
        tabProfile: "Profile",
        tabInfo: "Info",
        tabFiles: "Files",
        infoTitle: "Information",
        ipLabel: "IP Address:",
        linkLabel: "Link:",
        discordLinkText: "discord group",
        applicationMessage: "To join the server, you need to apply in Discord; all details are in Toploardgg.",
        rulesHeading: "Server Rules:",
        rule_1: "Don't tell anyone about Fight Club.",
        rule_2: "Do not destroy other players' bases or build without permission. Violation - one week ban.",
        rule_3: "Spam in Minecraft or on the Discord server, or posting irrelevant information in the Telegram group - 1 day mute (sending photos is allowed, as is any kind of information like coordinates or resource locations).",
        rule_4: "CHEATS ARE STRICTLY PROHIBITED in any form: resource packs or mods for ore visibility, or powerful cheats. Violation - ban from 1 day to permanent depending on the severity of the cheats. To clarify if a mod is a cheat, you need to ask the administrator (me). You can ask for unban, but you must write the reason in at least 3 sentences.",
        rule_5: "Do not provoke or be provoked. Violation - 1 day.",
        rule_6: "Do not judge a person based on their differences: weight, age, etc. Violation - 1 week.",
        rule_7: "Swearing in voice chat is not recommended.",
        rule_8: "You cannot build lag machines or other mechanisms that interfere with the server and reduce TPS.",
        rule_9: "You can only speak Ukrainian or at least Surzhyk.",
        serverStatusHeading: "Server Status:",
        statusLabel: "Status:",
        statusOnline: "Online",
        statusOffline: "Offline",
        statusLoading: "Loading...",
        playersLabel: "Players:",
        versionLabel: "Version:",
        motdLabel: "MOTD:",
        refreshButton: "Refresh",
        errorFetchingStatus: "Error fetching status.",
        statusOfflineMOTD: "Offline",
        filesTitle: "Files",
        filesDescription: "Here you can download server-related files, including the official resource packs and the build.",
        resourcepackDownloadOptifine: "Resource Pack (OptiFine)",
        resourcepackDownloadNonOptifine: "Resource Pack (Non-OptiFine)",
        filesDownloadBuild: "My Build",
        filesDownloadWorld: "world 1 season (Not available yet)",
        switchToDarkTheme: "Dark Theme",
        switchToLightTheme: "Light Theme"
    },
    ru: {
        greeting: "Привет.",
        cookies: "Я люблю печеньки)<🍪",
        name: "Toploardgg (Стас)",
        tyretName: "tyret (Артём)",
        kapibaraName: "KAPIBARA (Коля)",
        aterName: "ater (Денис)",
        artfixName: "Artfix (Артём)",
        contact: "Контакты:",
        support: "Поддержите нас:",
        donate: "Пожертвовать через PayPal",
        language: "Русский",
        tabProfile: "Профиль",
        tabInfo: "Инфо",
        tabFiles: "Файлы",
        infoTitle: "Информация",
        ipLabel: "IP Адрес:",
        linkLabel: "Ссылка:",
        discordLinkText: "группа в Discord",
        applicationMessage: "Чтобы попасть на сервер, надо подать заявку в Discord; все детали в Toploardgg.",
        rulesHeading: "Правила сервера:",
        rule_1: "Никому не рассказывать о Бойцовском Клубе.",
        rule_2: "Нельзя разрушать базы других игроков, а также строить без разрешения. Нарушение - неделя бана.",
        rule_3: "Спам в Minecraft или на Discord сервере, или написание неважной информации в Telegram группу - мут на 1 день (фотографии отправлять можно, информация любого вида - как координаты, так и нахождение ресурсов - тоже).",
        rule_4: "ЧИТЫ СТРОГО ЗАПРЕЩЕНЫ в любом виде: ресурспаки или моды на видимость руд, или сильные читы. Нарушение - бан от 1 дня до навсегда в зависимости от силы читов. Чтобы уточнить, является ли мод читом, нужно спросить у администратора (у меня). Разбан можно попросить, но нужно написать причину минимум 3 предложения.",
        rule_5: "Не провоцировать и не поддаваться на провокации. Нарушение - 1 день.",
        rule_6: "Нельзя осуждать человека за его отличия: вес, возраст и т.д. Нарушение - 1 неделя.",
        rule_7: "Нецензурная брань в голосовом чате нежелательна.",
        rule_8: "Нельзя строить лаг-машины или другие механизмы, которые мешают серверу и уменьшают TPS.",
        rule_9: "Разговаривать можно только на Украинском или по крайней мере на суржике.",
        serverStatusHeading: "Статус сервера:",
        statusLabel: "Статус:",
        statusOnline: "Онлайн",
        statusOffline: "Офлайн",
        statusLoading: "Загрузка...",
        playersLabel: "Игроков:",
        versionLabel: "Версия:",
        motdLabel: "MOTD:",
        refreshButton: "Обновить",
        errorFetchingStatus: "Ошибка получения статуса.",
        statusOfflineMOTD: "Офлайн",
        filesTitle: "Файлы",
        filesDescription: "Здесь вы можете скачать файлы, относящиеся к серверу, включая официальные ресурспаки и сборку.",
        resourcepackDownloadOptifine: "Ресурспак (OptiFine)",
        resourcepackDownloadNonOptifine: "Ресурспак (Non-OptiFine)",
        filesDownloadBuild: "Моя Сборка",
        filesDownloadWorld: "Мир 1 сезону (Пока что нельзя)",
        switchToDarkTheme: "Темная тема",
        switchToLightTheme: "Светлая тема"
    },
    uk: {
        greeting: "Привіт.",
        cookies: "Я обожнюю пряники)<🍪",
        name: "Toploardgg (Стаc)",
        tyretName: "tyret (Артем)",
        kapibaraName: "KAPIBARA (Коля)",
        aterName: "ater (Денис)",
        artfixName: "Artfix (Артем)",
        contact: "Контакти:",
        support: "Підтримайте нас:",
        donate: "Пожертвувати через PayPal",
        language: "Українська",
        tabProfile: "Профіль",
        tabInfo: "Інформація",
        tabFiles: "Файли",
        infoTitle: "Інформація",
        ipLabel: "IP Адреса:",
        linkLabel: "Посилання:",
        discordLinkText: "група в Discord",
        applicationMessage: "Щоб потрапити на сервер, треба подати заявку в діскорд всі деталі в Toploardgg.",
        rulesHeading: "Правила сервера:",
        rule_1: "Нікому не розказувати за Бійцівський Клуб.",
        rule_2: "Не можна руйнувати базу інших ігроків а також строїти без дозволу порушення-тиждень бану.",
        rule_3: "Спам у Minecraft або на Discord сервері, або надсилання неважливої інформації до Telegram групи - мут на 1 день (фотографії надсилати можна, інформацію будь-якого виду - як координати, так і знаходження ресурсів - також).",
        rule_4: "ЧІТИ СУВОРО ЗАБОРОНЕНІ у будь-якому вигляді: ресурспаки або моди на видимість руд, або сильні чити. Нарушення - бан від 1 дня до назавжди залежно від сили читів. Щоб уточнити, чи є мод читом, потрібно запитати у адміністратора (у мене). Розбан можна попросити, але потрібно написати причину мін. 3 речення.",
        rule_5: "Не провокувати і не піддаватися на провокації. Порушення - 1 день.",
        rule_6: "Не можна засуджувати людину за її відмінності: вага, вік тощо. Порушення - 1 тиждень.",
        rule_7: "Матюкатися у голосовому чаті краще не треба.",
        rule_8: "не можна строїти лаг машини або інші механізми які мішають серверу та зменшують тпс.",
        rule_9: "розмовляти можна тільки Українською або принаймі суржиком.",
        serverStatusHeading: "Статус сервера:",
        statusLabel: "Статус:",
        statusOnline: "Онлайн",
        statusOffline: "Офлайн",
        statusLoading: "Загрузка...",
        playersLabel: "Игроков:",
        versionLabel: "Версия:",
        motdLabel: "MOTD:",
        refreshButton: "Оновити",
        errorFetchingStatus: "Помилка отримання статусу.",
        statusOfflineMOTD: "Офлайн",
        filesTitle: "Файли",
        filesDescription: "Тут ви можете завантажити файли, що стосуються сервера, включаючи офіційні ресурспаки та збірку.",
        resourcepackDownloadOptifine: "Ресурспак (OptiFine)",
        resourcepackDownloadNonOptifine: "Ресурспак (Non-OptiFine)",
        filesDownloadBuild: "Моя Збірка",
        filesDownloadWorld: "Світ 1 сезону (Поки що не можна)",
        switchToDarkTheme: "Темна тема",
        switchToLightTheme: "Світла тема"
    }
};

let greetingElement, cookiesElement, nameElement, tyretNameElement, kapibaraNameElement, aterNameElement, artfixNameElement,
    contactElement, supportElement, donateElement, cookiesFooterElement, langButtonElement,
    tabBtnProfileElement, tabBtnInfoElement, tabBtnFilesElement, infoTitleElement, ipLabelElement,
    linkLabelElement, discordLinkTextElement, applicationMessageElement, rulesHeadingElement,
    serverStatusHeadingElement, statusLabelElement, playersLabelElement, versionLabelElement,
    motdLabelElement, refreshButtonElement, filesTitleElement, filesDescriptionElement,
    resourcepackDownloadOptifineElement, resourcepackDownloadNonOptifineElement, filesDownloadBuildElement, filesDownloadWorldElement;

const ruleElements = {};
const serverOnlineInfo = document.getElementById('server-online-info');
const playersOnline = document.getElementById('players-online');
const playersMax = document.getElementById('players-max');
const serverVersion = document.getElementById('server-version');
const serverMotd = document.getElementById('server-motd');
const statusIndicator = document.getElementById('status-indicator');
const serverRefreshButton = document.getElementById('server-refresh-button');
const themeToggle = document.getElementById('theme-toggle');
const languageButton = document.getElementById('language-button');
const bodyElement = document.body;

const ATERNOS_SERVER_ADDRESS_PORT = 'Toploardgg.aternos.me:39466';
const EXPECTED_MOTD = 'Welcome to the server of Toploardgg!';
const MCSTATUS_API_URL = `https://api.mcstatus.io/v2/status/java/${ATERNOS_SERVER_ADDRESS_PORT}`;

function smoothTextChange(element, newText) {
    if (!element) return;
    element.style.transition = 'opacity 0.28s';
    element.style.opacity = '0';
    setTimeout(() => {
        element.textContent = newText;
        element.style.opacity = '1';
    }, 170);
}

function setTheme(theme) {
    document.documentElement.style.setProperty('--transition-theme', 'background-color 0.6s, color 0.6s');
    bodyElement.style.transition = 'background-color 0.6s, color 0.6s';
    const currentLang = localStorage.getItem('preferredLanguage') || 'en';
    const currentTranslations = translations[currentLang];
    if (theme === 'light') {
        bodyElement.classList.add('light-theme');
        if (themeToggle) smoothTextChange(themeToggle, currentTranslations.switchToDarkTheme);
    } else {
        bodyElement.classList.remove('light-theme');
        if (themeToggle) smoothTextChange(themeToggle, currentTranslations.switchToLightTheme);
    }
    try {
        localStorage.setItem('theme', theme);
    } catch (e) {}
}

if (themeToggle) {
    themeToggle.addEventListener('click', () => {
        const currentTheme = bodyElement.classList.contains('light-theme') ? 'light' : 'dark';
        setTheme(currentTheme === 'dark' ? 'light' : 'dark');
    });
}

function loadThemePreference() {
    let savedTheme = null;
    try {
        savedTheme = localStorage.getItem('theme');
    } catch (e) {}
    if (savedTheme) {
        setTheme(savedTheme);
    } else {
        setTheme('dark');
    }
}

function showTab(tabIdToShow) {
    const contents = document.querySelectorAll('.tab-content');
    const buttons = document.querySelectorAll('.tab-button');
    contents.forEach(content => {
        if (content.id === `tab-content-${tabIdToShow}`) {
            content.classList.add('fadein', 'active');
            setTimeout(() => {
                content.classList.remove('fadein');
            }, 420);
        } else {
            if (content.classList.contains('active')) {
                content.classList.add('fadeout');
                setTimeout(() => {
                    content.classList.remove('active', 'fadeout');
                }, 420);
            }
        }
    });
    buttons.forEach(button => {
        if (button.id === `tab-btn-${tabIdToShow}`) {
            button.classList.add('active');
        } else {
            button.classList.remove('active');
        }
    });
    if (tabIdToShow === 'info') {
        fetchServerStatus();
        startStatusInterval();
    } else {
        stopStatusInterval();
    }
}

function changeLanguage(lang) {
    const currentTranslations = translations[lang];
    if (!currentTranslations) return;
    try {
        localStorage.setItem('preferredLanguage', lang);
    } catch (e) {}
    [
        [greetingElement, currentTranslations.greeting],
        [cookiesElement, currentTranslations.cookies],
        [nameElement, currentTranslations.name],
        [tyretNameElement, currentTranslations.tyretName],
        [kapibaraNameElement, currentTranslations.kapibaraName],
        [aterNameElement, currentTranslations.aterName],
        [artfixNameElement, currentTranslations.artfixName],
        [contactElement, currentTranslations.contact],
        [supportElement, currentTranslations.support],
        [donateElement, currentTranslations.donate],
        [cookiesFooterElement, currentTranslations.cookies],
        [langButtonElement, currentTranslations.language],
        [tabBtnProfileElement, currentTranslations.tabProfile],
        [tabBtnInfoElement, currentTranslations.tabInfo],
        [tabBtnFilesElement, currentTranslations.tabFiles],
        [infoTitleElement, currentTranslations.infoTitle],
        [ipLabelElement, currentTranslations.ipLabel],
        [linkLabelElement, currentTranslations.linkLabel],
        [discordLinkTextElement, currentTranslations.discordLinkText],
        [applicationMessageElement, currentTranslations.applicationMessage],
        [rulesHeadingElement, currentTranslations.rulesHeading],
        [serverStatusHeadingElement, currentTranslations.serverStatusHeading],
        [statusLabelElement, currentTranslations.statusLabel],
        [playersLabelElement, currentTranslations.playersLabel],
        [versionLabelElement, currentTranslations.versionLabel],
        [motdLabelElement, currentTranslations.motdLabel],
        [refreshButtonElement, currentTranslations.refreshButton],
        [filesTitleElement, currentTranslations.filesTitle],
        [filesDescriptionElement, currentTranslations.filesDescription],
        [resourcepackDownloadOptifineElement, currentTranslations.resourcepackDownloadOptifine],
        [resourcepackDownloadNonOptifineElement, currentTranslations.resourcepackDownloadNonOptifine],
        [filesDownloadBuildElement, currentTranslations.filesDownloadBuild],
        [filesDownloadWorldElement, currentTranslations.filesDownloadWorld]
    ].forEach(([el, txt]) => smoothTextChange(el, txt));
    for (let i = 1; i <= 9; i++) {
        if (ruleElements[`rule-${i}`]) {
            smoothTextChange(ruleElements[`rule-${i}`], currentTranslations[`rule_${i}`]);
        }
    }
    if (statusIndicator) {
        if (statusIndicator.classList.contains('status-online')) {
            smoothTextChange(statusIndicator, currentTranslations.statusOnline);
        } else if (statusIndicator.classList.contains('status-offline')) {
            let errorPart = '';
            const errorMatch = statusIndicator.textContent.match(/\s?\(.+\)$/);
            if (errorMatch) errorPart = errorMatch[0];
            let baseOfflineText = currentTranslations.statusOffline;
            let wasOfflineMotd = false;
            for (const langKey of ['en', 'ru', 'uk']) {
                const oldMotdOfflineText = translations[langKey].statusOfflineMOTD;
                if (statusIndicator.textContent.trim().startsWith(oldMotdOfflineText.substring(0, oldMotdOfflineText.indexOf('(')).trim())) {
                    wasOfflineMotd = true;
                    break;
                }
            }
            if (wasOfflineMotd) {
                baseOfflineText = currentTranslations.statusOfflineMOTD;
            }
            smoothTextChange(statusIndicator, baseOfflineText + errorPart);
        } else if (statusIndicator.classList.contains('status-loading')) {
            smoothTextChange(statusIndicator, currentTranslations.statusLoading);
        }
    }
    const currentTheme = bodyElement.classList.contains('light-theme') ? 'light' : 'dark';
    setTheme(currentTheme);
}

async function fetchServerStatus() {
    const currentLang = localStorage.getItem('preferredLanguage') || 'en';
    const currentTranslations = translations[currentLang];
    smoothTextChange(statusIndicator, currentTranslations.statusLoading);
    statusIndicator.className = 'server-status-indicator status-loading';
    serverOnlineInfo.style.display = 'none';
    serverRefreshButton.disabled = true;
    try {
        const response = await fetch(MCSTATUS_API_URL);
        if (!response.ok) throw new Error();
        const data = await response.json();
        const receivedMotdRaw = data.motd ? (data.motd.clean || data.motd.raw || '') : '';
        const receivedMotdClean = receivedMotdRaw.replace(/§[0-9a-fk-or]/gi, '').trim();
        const isOnlineByApi = data.online === true;
        const isMotdMatching = receivedMotdClean.toLowerCase().trim() === EXPECTED_MOTD.toLowerCase().trim();
        if (isOnlineByApi && isMotdMatching) {
            smoothTextChange(statusIndicator, currentTranslations.statusOnline);
            statusIndicator.className = 'server-status-indicator status-online';
            playersOnline.textContent = data.players ? data.players.online : 0;
            playersMax.textContent = data.players ? data.players.max : 0;
            serverVersion.textContent = data.version ? data.version.name : 'N/A';
            serverMotd.textContent = receivedMotdClean || 'N/A';
            serverOnlineInfo.style.display = 'block';
        } else {
            smoothTextChange(statusIndicator, currentTranslations.statusOffline);
            statusIndicator.className = 'server-status-indicator status-offline';
            serverOnlineInfo.style.display = 'none';
            serverMotd.textContent = '-';
        }
    } catch (error) {
        const currentLang = localStorage.getItem('preferredLanguage') || 'en';
        const currentTranslations = translations[currentLang];
        smoothTextChange(statusIndicator, currentTranslations.statusOffline);
        statusIndicator.className = 'server-status-indicator status-offline';
        serverOnlineInfo.style.display = 'none';
        serverMotd.textContent = '-';
    } finally {
        serverRefreshButton.disabled = false;
    }
}

const refreshInterval = 60000;
let statusIntervalId = null;

function startStatusInterval() {
    if (statusIntervalId === null) {
        fetchServerStatus();
        statusIntervalId = setInterval(() => {
            const activeTabElement = document.querySelector('.tab-content.active');
            const activeTabId = activeTabElement ? activeTabElement.id.replace('tab-content-', '') : null;
            if (activeTabId === 'info') {
                fetchServerStatus();
            }
        }, refreshInterval);
    }
}

function stopStatusInterval() {
    if (statusIntervalId !== null) {
        clearInterval(statusIntervalId);
        statusIntervalId = null;
    }
}

if (serverRefreshButton) {
    serverRefreshButton.addEventListener('click', fetchServerStatus);
}

document.addEventListener('DOMContentLoaded', () => {
    greetingElement = document.getElementById("greeting");
    cookiesElement = document.getElementById("I-love-cookies");
    nameElement = document.getElementById("name");
    tyretNameElement = document.getElementById("tyret-name");
    kapibaraNameElement = document.getElementById("kapibara-name");
    aterNameElement = document.getElementById("ater-name");
    artfixNameElement = document.getElementById("artfix-name");
    contactElement = document.getElementById("contact");
    supportElement = document.getElementById("support");
    donateElement = document.getElementById("donate");
    cookiesFooterElement = document.getElementById("I-love-cookies-footer");
    langButtonElement = document.getElementById('language-button');
    tabBtnProfileElement = document.getElementById("tab-btn-profile");
    tabBtnInfoElement = document.getElementById("tab-btn-info");
    tabBtnFilesElement = document.getElementById("tab-btn-files");
    infoTitleElement = document.getElementById("info-title");
    ipLabelElement = document.getElementById("ip-label");
    linkLabelElement = document.getElementById("linkLabel");
    discordLinkTextElement = document.getElementById("discord-link-text");
    applicationMessageElement = document.getElementById("application-message");
    rulesHeadingElement = document.getElementById("rules-heading");
    for (let i = 1; i <= 9; i++) {
        ruleElements[`rule-${i}`] = document.getElementById(`rule-${i}`);
    }
    serverStatusHeadingElement = document.getElementById('server-status-heading');
    statusLabelElement = document.getElementById('status-label');
    playersLabelElement = document.getElementById('players-label');
    versionLabelElement = document.getElementById('version-label');
    motdLabelElement = document.getElementById('motd-label');
    refreshButtonElement = document.getElementById('server-refresh-button');
    filesTitleElement = document.getElementById('files-title');
    filesDescriptionElement = document.getElementById('files-description');
    resourcepackDownloadOptifineElement = document.getElementById('resourcepack-download-optifine');
    resourcepackDownloadNonOptifineElement = document.getElementById('resourcepack-download-nonoptifine');
    filesDownloadBuildElement = document.getElementById('files-download-build');
    filesDownloadWorldElement = document.getElementById('files-download-world');
    let savedLang = 'en';
    try {
        const savedLangPref = localStorage.getItem('preferredLanguage');
        if (savedLangPref && translations[savedLangPref]) {
            savedLang = savedLangPref;
        }
    } catch (e) {}
    changeLanguage(savedLang);
    loadThemePreference();
    const initialTabId = 'profile';
    showTab(initialTabId);
    const tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.id.replace('tab-btn-', '');
            showTab(tabId);
        });
    });
    if (languageButton) {
        languageButton.addEventListener('click', () => {
            const currentLang = localStorage.getItem('preferredLanguage') || 'en';
            const availableLangs = Object.keys(translations);
            const currentIndex = availableLangs.indexOf(currentLang);
            const nextIndex = (currentIndex + 1) % availableLangs.length;
            const nextLang = availableLangs[nextIndex];
            changeLanguage(nextLang);
        });
    }
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });
    document.documentElement.style.scrollBehavior = 'smooth';
});

window.addEventListener('beforeunload', stopStatusInterval);