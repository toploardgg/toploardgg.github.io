const translations = {
    en: {
        greeting:"Hi.", cookies:"I love cookies)<🍪", name:"Toploardgg (Stas)", tyretName:"tyret (Artem)", kapibaraName:"KAPIBARA (Kolya)", aterName:"ater (Dinis)",
        contact:"Contacts:", support:"Support us:", donate:"Donate with PayPal", language:"English",
        tabProfile:"Profile", tabInfo:"Info", tabResourcepack:"Resource Pack", infoTitle:"Information",
        ipLabel:"IP Address:", linkLabel:"Link:", discordLinkText:"discord group",
        applicationMessage:"To join the server, you need to apply in Discord; all details are in Toploardgg.",
        rulesHeading:"Server Rules:",
        rule_1:"Don't tell anyone about Fight Club.",
        rule_2:"Do not destroy other players' bases or build without permission. Violation - one week ban.",
        rule_3:"Spam in Minecraft or on the Discord server, or posting irrelevant information in the Telegram group - 1 day mute (sending photos is allowed, as is any kind of information like coordinates or resource locations).",
        rule_4:"CHEATS ARE STRICTLY PROHIBITED in any form: resource packs or mods for ore visibility, or powerful cheats. Violation - ban from 1 day to permanent depending on the severity of the cheats. To clarify if a mod is a cheat, you need to ask the administrator (me). You can ask for unban, but you must write the reason in at least 3 sentences.",
        rule_5:"Do not provoke or be provoked. Violation - 1 day.",
        rule_6:"Do not judge a person based on their differences: weight, age, etc. Violation - 1 week.",
        rule_7:"Swearing in voice chat is not recommended.",
        rule_8:"You cannot build lag machines or other mechanisms that interfere with the server and reduce TPS.",
        rule_9:"You can only speak Ukrainian or at least Surzhyk.",
        serverStatusHeading:"Server Status:", statusLabel:"Status:", statusOnline:"Online", statusOffline:"Offline", statusLoading:"Loading...",
        playersLabel:"Players:", versionLabel:"Version:", motdLabel:"MOTD:", refreshButton:"Refresh",
        errorFetchingStatus:"Error fetching status.", statusOfflineMOTD:"Offline (Invalid MOTD)",
        resourcepackTitle:"Resource Pack", resourcepackDescription:"Here you can download the server's official resourcepack.",
        resourcepackDownloadOptifine:"toploardgg-optifine", resourcepackDownloadNonOptifine:"toploardgg"
    },
    ru: {
        greeting:"Привет.", cookies:"Я люблю печеньки)<🍪", name:"Toploardgg (Стас)", tyretName:"tyret (Артём)", kapibaraName:"KAPIBARA (Коля)", aterName:"ater (Денис)",
        contact:"Контакты:", support:"Поддержите нас:", donate:"Пожертвовать через PayPal", language:"Русский",
        tabProfile:"Профиль", tabInfo:"Инфо", tabResourcepack:"Ресурспак", infoTitle:"Информация",
        ipLabel:"IP Адрес:", linkLabel:"Ссылка:", discordLinkText:"группа в Discord",
        applicationMessage:"Чтобы попасть на сервер, надо подать заявку в Discord; все детали в Toploardgg.",
        rulesHeading:"Правила сервера:",
        rule_1:"Никому не рассказывать о Бойцовском Клубе.",
        rule_2:"Нельзя разрушать базы других игроков, а также строить без разрешения. Нарушение - неделя бана.",
        rule_3:"Спам в Minecraft или на Discord сервере, или написание неважной информации в Telegram группу - мут на 1 день (фотографии отправлять можно, информацию любого вида - как координаты, так и нахождение ресурсов - тоже).",
        rule_4:"ЧИТЫ СТРОГО ЗАПРЕЩЕНЫ в любом виде: ресурспаки или моды на видимость руд, или сильные читы. Нарушение - бан от 1 дня до навсегда в зависимости от силы читов. Чтобы уточнить, является ли мод читом, нужно спросить у администратора (у меня). Разбан можно попросить, но нужно написать причину минимум 3 предложения.",
        rule_5:"Не провоцировать и не поддаваться на провокации. Нарушение - 1 день.",
        rule_6:"Нельзя осуждать человека за его отличия: вес, возраст и т.д. Нарушение - 1 неделя.",
        rule_7:"Нецензурная брань в голосовом чате нежелательна.",
        rule_8:"Нельзя строить лаг-машины или другие механизмы, которые мешают серверу и уменьшают TPS.",
        rule_9:"Разговаривать можно только на Украинском или по крайней мере на суржике.",
        serverStatusHeading:"Статус сервера:", statusLabel:"Статус:", statusOnline:"Онлайн", statusOffline:"Офлайн", statusLoading:"Загрузка...",
        playersLabel:"Игроков:", versionLabel:"Версия:", motdLabel:"MOTD:", refreshButton:"Обновить",
        errorFetchingStatus:"Ошибка получения статуса.", statusOfflineMOTD:"Офлайн (Неверный MOTD)",
        resourcepackTitle:"Ресурспак", resourcepackDescription:"Здесь вы можете скачать официальный ресурспак сервера.",
        resourcepackDownloadOptifine:"toploardgg-optifine", resourcepackDownloadNonOptifine:"toploardgg"
    },
    uk: {
        greeting:"Привіт.", cookies:"Я обожнюю пряники)<🍪", name:"Toploardgg (Стаc)", tyretName:"tyret (Артем)", kapibaraName:"KAPIBARA (Коля)", aterName:"ater (Денис)",
        contact:"Контакти:", support:"Підтримайте нас:", donate:"Пожертвувати через PayPal", language:"Українська",
        tabProfile:"Профіль", tabInfo:"Інформація", tabResourcepack:"Ресурспак", infoTitle:"Інформація",
        ipLabel:"IP Адреса:", linkLabel:"Посилання:", discordLinkText:"група в Discord",
        applicationMessage:"Щоб потрапити на сервер, треба подати заявку в діскорд всі деталі в Toploardgg.",
        rulesHeading:"Правила сервера:",
        rule_1:"Нікому не розказувати за Бійцівський Клуб.",
        rule_2:"Не можна руйнувати базу інших ігроків а також строїти без дозволу порушення-тиждень бану.",
        rule_3:"Спам у Minecraft або на Discord сервері, або надсилання неважливої інформації до Telegram групи - мут на 1 день (фотографії надсилати можна, інформацію будь-якого виду - як координати, так і знаходження ресурсів - також).",
        rule_4:"ЧІТИ СУВОРО ЗАБОРОНЕНІ у будь-якому вигляді: ресурспаки або моди на видимість руд, або сильні чити. Порушення - бан від 1 дня до назавжди залежно від сили читів. Щоб уточнити, чи є мод читом, потрібно запитати у адміністратора (у мене). Розбан можна попросити, але потрібно написати причину мін. 3 речення.",
        rule_5:"Не провокувати і не піддаватися на провокації. Порушення - 1 день.",
        rule_6:"Не можна засуджувати людину за її відмінності: вага, вік тощо. Порушення - 1 тиждень.",
        rule_7:"Матюкатися у голосовому чаті краще не треба.",
        rule_8:"не можна строїти лаг машини або інші механізми які мішають серверу та зменшують тпс.",
        rule_9:"розмовляти можна тільки Українською або принаймі суржиком.",
        serverStatusHeading:"Статус сервера:", statusLabel:"Статус:", statusOnline:"Онлайн", statusOffline:"Офлайн", statusLoading:"Завантаження...",
        playersLabel:"Гравців:", versionLabel:"Версія:", motdLabel:"MOTD:", refreshButton:"Оновити",
        errorFetchingStatus:"Помилка отримання статусу.", statusOfflineMOTD:"Офлайн (Невірний MOTD)",
        resourcepackTitle:"Ресурспак", resourcepackDescription:"Тут ви можете завантажити офіційний ресурспак сервера.",
        resourcepackDownloadOptifine:"toploardgg-optifine", resourcepackDownloadNonOptifine:"toploardgg"
    }
};

// Получаем элементы страницы
const statusIndicator = document.getElementById('status-indicator');
const serverOnlineInfo = document.getElementById('server-online-info');
const playersOnline = document.getElementById('players-online');
const playersMax = document.getElementById('players-max');
const serverVersion = document.getElementById('server-version');
const serverMotd = document.getElementById('server-motd');
const serverRefreshButton = document.getElementById('server-refresh-button');

// Настройки сервера
const ATERNOS_SERVER_ADDRESS_PORT = 'Toploardgg.aternos.me:39466'; // <-- Здесь ваш IP и порт
const EXPECTED_MOTD = 'Welcome to the server of Toploardgg!'; // <-- Ожидаемый MOTD
const MCSTATUS_API_URL = `https://api.mcstatus.io/v2/status/java/${ATERNOS_SERVER_ADDRESS_PORT}`;

// Функция для переключения вкладок
function showTab(tabIdToShow) {
    const contents = document.querySelectorAll('.tab-content');
    contents.forEach(content => { content.classList.remove('active'); });
    const buttons = document.querySelectorAll('.tab-button');
    buttons.forEach(button => { button.classList.remove('active'); });

    const contentToShow = document.getElementById(`tab-content-${tabIdToShow}`);
    if (contentToShow) {
        contentToShow.classList.add('active');
        // Если переключились на вкладку "Инфо", начинаем обновлять статус сервера
        if (tabIdToShow === 'info') {
            fetchServerStatus();
            startStatusInterval();
        } else {
            // Если переключились на другую вкладку, останавливаем обновление статуса
            stopStatusInterval();
        }
    }

    const buttonToActivate = document.getElementById(`tab-btn-${tabIdToShow}`);
    if (buttonToActivate) { buttonToActivate.classList.add('active'); }
}

// Функция для смены языка
function changeLanguage(lang) {
    const currentTranslations = translations[lang];
    if (!currentTranslations) return;

    // Обновляем текст на странице в соответствии с выбранным языком
    document.getElementById("greeting").textContent = currentTranslations.greeting;
    document.getElementById("I-love-cookies").textContent = currentTranslations.cookies;
    document.getElementById("name").textContent = currentTranslations.name;
    document.getElementById("tyret-name").textContent = currentTranslations.tyretName;
    document.getElementById("kapibara-name").textContent = currentTranslations.kapibaraName;
    document.getElementById("ater-name").textContent = currentTranslations.aterName;
    document.getElementById("contact").textContent = currentTranslations.contact;
    document.getElementById("support").textContent = currentTranslations.support;
    document.getElementById("donate").textContent = currentTranslations.donate;
    document.getElementById("I-love-cookies-footer").textContent = currentTranslations.cookies;
    document.getElementById("language-button").textContent = currentTranslations.language;
    document.getElementById("tab-btn-profile").textContent = currentTranslations.tabProfile;
    document.getElementById("tab-btn-info").textContent = currentTranslations.tabInfo;

    const tabResourcepackButton = document.getElementById("tab-btn-resourcepack");
    if (tabResourcepackButton) { tabResourcepackButton.textContent = currentTranslations.tabResourcepack; }

    document.getElementById("info-title").textContent = currentTranslations.infoTitle;
    document.getElementById("ip-label").textContent = currentTranslations.ipLabel;
    document.getElementById("linkLabel").textContent = currentTranslations.linkLabel;
    document.getElementById("discord-link-text").textContent = currentTranslations.discordLinkText;

    const applicationMessageElement = document.getElementById("application-message");
    if (applicationMessageElement) { applicationMessageElement.textContent = currentTranslations.applicationMessage; }

    const rulesHeading = document.getElementById("rules-heading");
    if (rulesHeading) { rulesHeading.textContent = currentTranslations.rulesHeading; }

    for (let i = 1; i <= 9; i++) {
        const ruleElement = document.getElementById(`rule-${i}`);
        if (ruleElement) { ruleElement.textContent = currentTranslations[`rule_${i}`]; }
    }

    const serverStatusHeading = document.getElementById('server-status-heading');
    const statusLabel = document.getElementById('status-label');
    const playersLabel = document.getElementById('players-label');
    const versionLabel = document.getElementById('version-label');
    const motdLabel = document.getElementById('motd-label');
    const refreshButton = document.getElementById('server-refresh-button');
    const statusIndicator = document.getElementById('status-indicator');

    if (serverStatusHeading) serverStatusHeading.textContent = currentTranslations.serverStatusHeading;
    if (statusLabel) statusLabel.textContent = currentTranslations.statusLabel;
    if (playersLabel) playersLabel.textContent = currentTranslations.playersLabel;
    if (versionLabel) versionLabel.textContent = currentTranslations.versionLabel;
    if (motdLabel) motdLabel.textContent = currentTranslations.motdLabel;
    if (refreshButton) refreshButton.textContent = currentTranslations.refreshButton;

    // Обновление текста индикатора статуса сервера с учетом текущего состояния
    if (statusIndicator) {
         const currentIndicatorText = statusIndicator.textContent;
         const errorMatch = currentIndicatorText.match(/\s\(.*\)$/); // Находим текст в скобках, если есть
         const errorText = errorMatch ? errorMatch[0] : '';
         const baseStatusText = currentTranslations.statusOffline;
         const offlineMotdTextCurrentLang = currentTranslations.statusOfflineMOTD;

         if (statusIndicator.classList.contains('status-online')) {
             statusIndicator.textContent = currentTranslations.statusOnline;
         } else if (statusIndicator.classList.contains('status-offline')) {
              // Проверяем, содержит ли текущий текст базовую фразу для перевода
              if (currentIndicatorText.includes('(') && currentIndicatorText.substring(0, currentIndicatorText.indexOf('(')).trim() === translations['en'].statusOfflineMOTD.substring(0, translations['en'].statusOfflineMOTD.indexOf('(')).trim()) {
                   statusIndicator.textContent = offlineMotdTextCurrentLang + errorText;
              } else {
                   statusIndicator.textContent = baseStatusText + errorText;
              }
         } else {
             statusIndicator.textContent = currentTranslations.statusLoading;
         }
    }

    const resourcepackTitleElement = document.getElementById('resourcepack-title');
    const resourcepackDescriptionElement = document.getElementById('resourcepack-description');
    const resourcepackDownloadOptifineElement = document.getElementById('resourcepack-download-optifine');
    const resourcepackDownloadNonOptifineElement = document.getElementById('resourcepack-download-non-optifine'); // Исправлен id

    if (resourcepackTitleElement) resourcepackTitleElement.textContent = currentTranslations.resourcepackTitle;
    if (resourcepackDescriptionElement) resourcepackDescriptionElement.textContent = currentTranslations.resourcepackDescription;
    if (resourcepackDownloadOptifineElement) resourcepackDownloadOptifineElement.textContent = currentTranslations.resourcepackDownloadOptifine;
     // Проверяем существование элемента перед обновлением текста
    if (resourcepackDownloadNonOptifineElement) resourcepackDownloadNonOptifineElement.textContent = currentTranslations.resourcepackDownloadNonOptifine;


    // Сохраняем выбранный язык в Local Storage
    localStorage.setItem('preferredLanguage', lang);
}

// Функция для получения статуса сервера
async function fetchServerStatus() {
    const currentLang = localStorage.getItem('preferredLanguage') || 'en';
    const currentTranslations = translations[currentLang];

    // Устанавливаем статус "Загрузка..."
    statusIndicator.textContent = currentTranslations.statusLoading;
    statusIndicator.className = 'server-status-indicator status-loading';
    serverOnlineInfo.style.display = 'none'; // Скрываем инфо, пока грузим
    serverRefreshButton.disabled = true; // Отключаем кнопку обновления

    try {
        const response = await fetch(MCSTATUS_API_URL);
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }
        const data = await response.json();

        // Очищаем MOTD от форматирования и пробелов
        const receivedMotdRaw = data.motd ? (data.motd.clean || data.motd.raw || '') : '';
        const receivedMotdClean = receivedMotdRaw.replace(/§[0-9a-fk-or]/gi, '').trim();

        // Проверяем статус по API и совпадение MOTD
        const isOnlineByApi = data.online === true;
        const isMotdMatching = receivedMotdClean === EXPECTED_MOTD.trim();

        if (isOnlineByApi && isMotdMatching) {
            // Сервер онлайн и MOTD совпадает
            statusIndicator.textContent = currentTranslations.statusOnline;
            statusIndicator.className = 'server-status-indicator status-online';
            playersOnline.textContent = data.players ? data.players.online : 0;
            playersMax.textContent = data.players ? data.players.max : 0;
            serverVersion.textContent = data.version ? data.version.name : 'N/A';
            serverMotd.textContent = receivedMotdClean || currentTranslations.motdLabel + ' - N/A';
            serverOnlineInfo.style.display = 'block'; // Показываем инфо
        } else {
            // Сервер офлайн или MOTD не совпадает
            let offlineMessage = currentTranslations.statusOffline;
             if (isOnlineByApi && !isMotdMatching) {
               // Сервер онлайн, но MOTD неправильный
               offlineMessage = currentTranslations.statusOfflineMOTD + (receivedMotdClean ? ` (${receivedMotdClean})` : '');
             } else if (data.error) {
               // Ошибка от API с сообщением
               offlineMessage = `${currentTranslations.statusOffline} (${data.error})`;
             } else if (!isOnlineByApi) {
                // API сказал, что сервер офлайн
                offlineMessage = currentTranslations.statusOffline;
             } else {
                // Другая ошибка при получении статуса
                offlineMessage = `${currentTranslations.statusOffline} (${currentTranslations.errorFetchingStatus})`;
             }
            statusIndicator.textContent = offlineMessage;
            statusIndicator.className = 'server-status-indicator status-offline';
            serverOnlineInfo.style.display = 'none'; // Скрываем инфо
            serverMotd.textContent = '-';
        }
    } catch (error) {
        // Ошибка при выполнении запроса
        console.error('Ошибка при получении статуса:', error);
        const currentLang = localStorage.getItem('preferredLanguage') || 'en';
        const currentTranslations = translations[currentLang];
        statusIndicator.textContent = `${currentTranslations.statusOffline} (${currentTranslations.errorFetchingStatus} ${error.message || error})`;
        statusIndicator.className = 'server-status-indicator status-offline';
        serverOnlineInfo.style.display = 'none';
        serverMotd.textContent = '-';
    } finally {
        // В любом случае, включаем кнопку обновления обратно
        serverRefreshButton.disabled = false;
    }
}

// Настройка интервала обновления статуса сервера (каждые 60 секунд)
const refreshInterval = 60000; // 60 секунд
let statusIntervalId = null; // Переменная для хранения ID интервала

// Функция для старта интервала обновления статуса
function startStatusInterval() {
    // Запускаем интервал только если он еще не запущен
    if (statusIntervalId === null) {
        statusIntervalId = setInterval(() => {
            // Обновляем статус только если активна вкладка "Инфо"
            const activeTabElement = document.querySelector('.tab-content.active');
            const activeTabId = activeTabElement ? activeTabElement.id.replace('tab-content-', '') : null;
            if (activeTabId === 'info') {
                fetchServerStatus();
            }
        }, refreshInterval);
    }
}

// Функция для остановки интервала обновления статуса
function stopStatusInterval() {
    if (statusIntervalId !== null) {
        clearInterval(statusIntervalId);
        statusIntervalId = null;
    }
}

// Обработчик клика по кнопке "Обновить статус"
if (serverRefreshButton) {
    serverRefreshButton.addEventListener('click', fetchServerStatus);
}

// Выполняем при загрузке страницы
document.addEventListener('DOMContentLoaded', () => {
    // Загружаем сохраненный язык из Local Storage или используем английский по умолчанию
    const savedLang = localStorage.getItem('preferredLanguage') || 'en';
    changeLanguage(savedLang);

    // Устанавливаем начальную вкладку (например, "Профиль")
    const initialTabId = 'profile';
    showTab(initialTabId); // Показываем эту вкладку

    // Если начальная вкладка оказалась "Инфо", сразу получаем статус сервера и запускаем интервал
    if (initialTabId === 'info') {
         fetchServerStatus();
         startStatusInterval();
    }
});

// Останавливаем интервал обновления статуса при закрытии страницы
window.addEventListener('beforeunload', stopStatusInterval);

// Примечание: Функция showTab и changeLanguage должны быть доступны глобально,
// т.к. вызываются из HTML через onclick.